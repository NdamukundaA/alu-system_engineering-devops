#!/usr/bin/env bash

# Update and upgrade the system
sudo apt update -y
sudo apt upgrade -y

# Install HAProxy
sudo apt install -y haproxy

# Enable HAProxy to start on boot
sudo systemctl enable haproxy

# Backup the original HAProxy configuration file
sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak

# Configure HAProxy for round-robin load balancing
cat <<EOL | sudo tee /etc/haproxy/haproxy.cfg
global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

frontend http-in
    bind *:80
    default_backend servers

backend servers
    balance roundrobin
    server web-01 192.168.1.101:80 check
    server web-02 192.168.1.102:80 check

# Enable stats page (optional for monitoring)
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats realm Haproxy\ Statistics
    stats auth admin:admin
EOL

# Reload HAProxy to apply the new configuration
sudo systemctl restart haproxy

# Verify HAProxy status
sudo systemctl status haproxy

# Test the load balancer by sending a request to the load balancer IP
curl -Is http://YOUR_LOAD_BALANCER_IP
